input {
  beats {
    port => 5044
  }
}

filter {
  # Try to parse JSON from the message field
  json {
    source => "message"
    skip_on_invalid_json => true
  }

  # Parse timestamp if available
  date {
    match => ["@timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Tag Suricata alerts
  if [event_type] == "alert" {
    mutate {
      add_tag => ["suricata_alert"]
    }
  }

  # Clean up extra fields for IoT logs (Filebeat)
  if [agent][name] =~ /filebeat/ {
    json {
      source => "message"
      remove_field => ["host", "agent", "ecs", "log", "input"]
    }
  }

  # You can add Metricbeat filters here if needed in the future
}

output {
  # Suricata alerts
  if "suricata_alert" in [tags] {
    elasticsearch {
      hosts => ["http://localhost:9200"]
      index => "suricata-%{+YYYY.MM.dd}"
    }
  }
  # IoT logs from Filebeat
  else if [agent][name] =~ /filebeat/ {
    elasticsearch {
      hosts => ["http://localhost:9200"]
      index => "iot-temp-%{+YYYY.MM.dd}"
    }
    stdout { codec => rubydebug }
  }
  # Metricbeat system data
  else if [agent][name] =~ /metricbeat/ {
    elasticsearch {
      hosts => ["http://localhost:9200"]
      index => "metricbeat-%{+YYYY.MM.dd}"
    }
  }
  # Fallback (optional)
  else {
    elasticsearch {
      hosts => ["http://localhost:9200"]
      index => "generic-%{+YYYY.MM.dd}"
    }
  }
}
